---
title: "M1 Mac ã§ Rust è£½ Lambda ã‚’ SAM ã‚’ã©ã†ã«ã‹ã—ã¦ä½¿ãˆã‚‹ã‚ˆã†ã«ã—ãŸè©±"
emoji: "ğŸš€"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["rust", "aws", "sam", "m1"]
published: true
---

## ãã£ã‹ã‘

æ–°ã—ã„ã‚‚ã®å¥½ãã§ã‚ã‚‹ç§ã¯ã€ä»Šå¹´ Rust ã‚’å§‹ã‚ã¾ã—ãŸã€‚ [The Rust Programming Language](https://doc.rust-lang.org/stable/book/) ã¯åˆã‚ã¦é«˜ç´šè¨€èªã‚’è§¦ã‚‹äººã«ã‚‚ã‚ã‹ã‚Šã‚„ã™ãã€ã¨ã¦ã‚‚è‰¯ã‹ã£ãŸã§ã™ã€‚

ä»•äº‹ã§æ–°ãŸã«ãƒãƒ¼ãƒ ã«ã‚¸ãƒ§ã‚¤ãƒ³ã—ãŸæ–°å’ãƒ¡ãƒ³ãƒãƒ¼ã« AWS ã«ã¤ã„ã¦è¬›ç¾©ã‚’è¡Œã„ã¾ã—ãŸãŒã€ä¹…ã€…ã«ã‚µãƒ¼ãƒãƒ¼ãƒ¬ã‚¹ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã‚’ãƒ•ãƒ«æ´»ç”¨ã—ãŸã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä½œã‚ŠãŸããªã‚Šã€ã›ã£ã‹ããªã‚‰ã°æœ€è¿‘å­¦ã‚“ã  Rust ã‚’ä½¿ã£ã¦ã¿ã‚ˆã†ã¨æ€ã£ãŸã®ãŒãã£ã‹ã‘ã§ã™ã€‚

## ã‚„ã£ã¦ã¿ãŸ

ã‚‚ã¨ã‚‚ã¨ä»–ã®é–‹ç™ºã§ AWS CLI ã¨ SAM ã‚„ Docker ã¯å…¥ã£ã¦ã„ãŸã®ã§ã€ [å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/building-rust.html) ã‚’ãƒ™ãƒ¼ã‚¹ã«ç°¡å˜ãªãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã‚’é€²ã‚ã‚ˆã†ã¨æ€ã£ã¦ã„ã¾ã—ãŸã€‚æ­£ç›´ã€å®Ÿè£…ã‚‚ç™ºç”Ÿã—ãªã„ãŸã‚ 30 åˆ†ç¨‹åº¦ã‚ã‚Œã°çµ‚ã‚ã‚‹ã ã‚ã†ã¨æ€ã£ã¦å§‹ã‚ã¦ã„ã¾ã—ãŸãŒã€m1 Mac ã‚’ä½¿ã£ã¦ã„ãŸãŒã‚†ãˆã«ã€æ€ã‚ã¬å•é¡Œã«ã¶ã¤ã‹ã‚Šã¾ã—ãŸã€‚

## å•é¡Œ

`sam build` ã¨ `sam deploy --guided` ã‚’ä½¿ã„ã€ Lambda ãŒç„¡äº‹ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã¾ã—ãŸãŒ CLI ã® Output ã«è¡¨ç¤ºã•ã‚ŒãŸã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã¸ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨ãªã‚“ã¨ã‚¤ãƒ³ã‚¿ãƒ¼ãƒŠãƒ«ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼ãŒè¿”ã•ã‚Œã¦ã—ã¾ã„ã¾ã—ãŸã€‚ã‚¨ãƒ©ãƒ¼ã‚’è¦‹ã‚‹é™ã‚Šã€è¦æ±‚ã—ã¦ã„ã‚‹ GLIBC ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒåˆã‚ãªã„ã‚ˆã†ã§ã—ãŸã€‚

```shell
/var/task/bootstrap: /lib64/libc.so.6: version `GLIBC_2.28' not found (required by /var/task/bootstrap)
```

Go ã§ã‚‚å‰ã«ä¼¼ãŸã‚ˆã†ãªã‚¨ãƒ©ãƒ¼ã«é­é‡ã—ã¦ãŠã‚Šã€ã“ã®ã¨ãã¯ `GOOS=linux GOARCH=amd64` ã‚’ä½¿ã£ã¦ãƒ“ãƒ«ãƒ‰ã™ã‚‹ã“ã¨ã§è§£æ±ºã—ãŸã‚‚ã®ã®ã€ `cargo` ã«ã¯ã“ã®ã‚ˆã†ãªã‚ªãƒ—ã‚·ãƒ§ãƒ³ãŒè‡ªåˆ†ã§èª¿ã¹ã‚‹é™ã‚Šã¯è¦‹ã¤ã‘ã‚‰ã‚Œãšã€ã‹ãªã‚Šå›°ã‚Šã¾ã—ãŸã€‚

ã“ã®ã‚ˆã†ãªå•é¡Œã¯å‰²ã¨å‰ã‹ã‚‰èªçŸ¥ã•ã‚Œã¦ã„ãŸã‚ˆã†ã§ã€ [awslabs/aws-lambda-rust-runtime#17](https://github.com/awslabs/aws-lambda-rust-runtime/issues/17) ã§ã‚‚è­°è«–ã•ã‚Œã¦ã„ã¾ã—ãŸã€‚

## è§£æ±ºç­–

> The alternative is to build on a container that matches the lambda runtime.

çµå±€ä¸Šã§ä¸Šã’ãŸ issue ã§è§£æ±ºã™ã‚‹ã®ãŒãƒ¯ãƒ¼ã‚¯ã‚¢ãƒ©ã‚¦ãƒ³ãƒ‰ã§ã€[devcontainer](https://containers.dev/) ã§è§£æ±ºã—ã¾ã—ãŸã€‚ï¼ˆå³å¯†ã«ã¯ VS Code ã®æ‹¡å¼µæ©Ÿèƒ½ã®æ–¹ã‚’ä½¿ã£ã¦ã„ã¾ã™ï¼‰

```json:.vscode/devcontainer.json
{
  "name": "Rust",
  "image": "mcr.microsoft.com/devcontainers/rust:1-1-bullseye",
  "mounts": [
    {
      "source": "${localEnv:HOME}/.aws",
      "target": "/home/vscode/.aws",
      "type": "bind"
    }
  ],
  "features": {
    "ghcr.io/audacioustux/devcontainers/aws-sam-cli:1": {},
    "ghcr.io/devcontainers/features/nix:1": {
      "packages": "nixpkgs.cargo-lambda",
      "useAttributePath": true
    },
    "ghcr.io/devcontainers/features/aws-cli:1": {},
    "ghcr.io/devcontainers/features/docker-in-docker:2": {}
  }
}
```

Rust ã‚’ãƒ™ãƒ¼ã‚¹ã‚¤ãƒ¡ãƒ¼ã‚¸ã¨ã—ã€ SAM CLIã€ AWS CLIã€ Docker in Docker ã¨ Nix ã«ã‚ˆã‚‹ `cargo-lambda` ã‚’ä½¿ã†ã“ã¨ã§ã€ç’°å¢ƒã‚’æ§‹ç¯‰ã—ã¾ã—ãŸã€‚ã¾ãŸã€ `.aws` ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ãƒã‚¦ãƒ³ãƒˆã™ã‚‹ã“ã¨ã§ã€ AWS ã®èªè¨¼æƒ…å ±ã‚’å…±æœ‰ã—ã¾ã—ãŸã€‚

ã“ã‚Œã«ã‚ˆã£ã¦ã€ä¸€åº¦ã“ã®æ§‹æˆã§ãƒ“ãƒ«ãƒ‰ã‚’ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ™ãƒ¼ã‚¹ã«å¿…è¦ãªã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒãƒ—ãƒªã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚ŒãŸçŠ¶æ…‹ã§é–‹ç™ºãŒã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚

ãŠã‚ã‚Š

PS: ã‚‚ã£ã¨ã„ã„æ–¹æ³•ãŒã‚ã‚Œã°æ•™ãˆã¦ãã ã•ã„ ğŸ™‡â€â™‚ï¸
